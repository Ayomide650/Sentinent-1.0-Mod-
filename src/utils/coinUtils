import { pool } from '../database/connection';

export async function getUserCoins(userId: string): Promise<number> {
    const result = await pool.query(
        'SELECT coins FROM user_coins WHERE user_id = $1',
        [userId]
    );
    return result.rows[0]?.coins || 0;
}

export async function updateUserCoins(userId: string, amount: number): Promise<void> {
    await pool.query(
        `INSERT INTO user_coins (user_id, coins) 
         VALUES ($1, $2)
         ON CONFLICT (user_id) 
         DO UPDATE SET coins = user_coins.coins + $2`,
        [userId, amount]
    );
}

export async function addMessageCoins(userId: string): Promise<void> {
    const lastMessage = await pool.query(
        'SELECT last_message FROM user_coins WHERE user_id = $1',
        [userId]
    );

    const now = new Date();
    if (!lastMessage.rows[0]?.last_message || 
        (now.getTime() - lastMessage.rows[0].last_message.getTime()) > 60000) {
        await updateUserCoins(userId, 5);
        await pool.query(
            'UPDATE user_coins SET last_message = NOW() WHERE user_id = $1',
            [userId]
        );
    }
}
